---
layout:     post
title:      "低成本搭建百万用户级APP —— 《蜜蜂少女队》"
subtitle:   "《推蜜》官方互动养成APP，借力《阿里云》从零到壹的演变"
date:       2017-02-26 10:00:00
author:     "李牧牧"
header-img: "http://onb688cva.bkt.clouddn.com/assets:img:home-bg.jpg"
header-mask: 0.1
catalog:    true
tags:
    - 阿里云
    - 混合云
    - 社交APP
    - 高并发
---

> 本文发布于 [李牧牧的博客](http://limumu.me) 转载请保留链接 ;)

  

摘要：

> 2015年05月APP上线注册量激增
>
> 2016年03月浙江卫视黄金档节目播出，注册量飙升访问量增大
>
> 2016年05月APP蜜决终极赛事，投票服务器Hold住高并发
>
> 2016年06月[海峡两岸、美国、澳大利亚]同时投票，揭榜最后一秒顶住超高并发请求
>
> ......

  

## 困境

应用上线之初，需要给移动端、H5前端、网站电商提供后端服务，那么服务器的稳定性、请求服务负载能力、资源存储能力、CDN内容分发网络、容量可伸缩数据库、数据融灾备份还原、日志短信预警、网络安全组分配等，都是保证应用稳定、快速的基本配置。



之前在上汽工作时，东家有自建 IDC 托管，购买昂贵的硬件服务器并部署自身的业务系统，专业的运维团队，整套部署需要斥巨资，对于初创中小企业可是笔不小的费用。

  

## 什么服务是烧钱的货？


>CDN就是互联网版的悍马，用户流量的增长好比踩油门，车子一旦发动就好像副驾驶坐着一大美女端着大把钞票，一张一张的朝窗外丢。

只要不是企业内部管理应用，但凡需要给到全国用户良好网络体验的应用，都需要CDN的支持。如 YY 、 斗鱼 、战旗每月单花在 CDN 上的费用小则几千万，大的需要上亿元，当然不是每个应用都能有这么大的流量，但相对其他服务花费来说，CDN还是蛮烧钱的。

[CDN市场的竞争为什么这么激烈](https://www.zhihu.com/question/53101008 "CDN市场的竞争为什么这么激烈")  - 来源知乎

[直播的CDN成本很高，到底有多高？这些数字太惊人](http://mt.sohu.com/20161010/n469898519.shtml "直播的CDN成本很高，到底有多高？这些数字太惊人") - 来源搜狐新闻



>网络运营商就是二房东，服务器好比房子，辣么贵的房子是你买的，你还要交租金。

机房、空调、UPS、机架、刀片机、光纤、电费，小企业每月少则几千、大的几万不止。

[阿里巴巴的服务器机房一天的耗电量大概是多少](https://www.zhihu.com/question/21410788/answer/18155010 "阿里巴巴的服务器机房一天的耗电量大概是多少")  - 来源知乎



> 时间就是金钱，把时间当朋友，和朋友处理最重要的事。

发布一套产品，从 SIT 到 PRD，从内测到上线，发包、备份、日志监控、增减服务器；搭建它们需要时间，维护它们也需要时间，如何组合起来形成可靠的解决方案更需要时间的积累。





## 为什么使用阿里云？

很多公司都是自己买硬件搭建服务器，为了业务上的buffer，自己的硬件肯定是不可能满负荷的，对于初创公司来说，最重要的是要控制成本，而大量的重复投入与回报不能成正比。另外技术复用价值非常惊人，云端服务器背后有专业的技术团队，成熟的7x24小时工单系统，当企业的用户量或者访问量猛增的时候，能平稳的服务好自己的用户才是重点。



![](http://onb688cva.bkt.clouddn.com/assets:post:img:20170327174031.png?imageView2/0/q/75|watermark/2/text/5p2O54mn54mnIGxpbXVtdS5tZQ==/font/5b6u6L2v6ZuF6buR/fontsize/520/fill/IzAwMDAwMA==/dissolve/100/gravity/SouthEast/dx/10/dy/10|imageslim)
* 阿里云生产架构资源分配图 *图片来源: 李牧牧 & [limumu.me][i1]*






## 上云之路


### 如何部署高可用的云系统？

> 尽可能利用缓存系统

- 用户登录Token、用户头像、签名、固定信息、一级缓存、频繁使用数据尽量放入自建或者阿里云缓存中，不要依赖硬盘的IO或数据库链接查询。

- 推荐用ECS搭建初期的缓存服务，当业务量上去，再迁移到阿里云的缓存解决方案；换句话说就是，用户流量小时用ECS自己搭建缓存服务就够用了，当用户流量增大时，建议不要通过增加ECS内存服务器数量的方式扩容缓存系统；核4G内存ECS（主从）服务器平均每月需要287.3元，而阿里云缓存产品平均每月只有204元，相对来说即划算又稳定，用户流量大了还是迁移到阿里云缓存产品中才好，并且缓存产品提供内存扩容、主从服务、融灾备份，确实节省了不少时间。

  ​

> 将静态资源存入 OSS 云存储并分配好域名

- 资源文件一定要区分开，像视频、图片、小文件要选择对应的存储类型

- OSS 云存储中不同作用的区域分配独立的二级域名，比如 video.domain.com img.domain.com

- 为了资源安全性，一定要区分好加密与非加密OSS区域，加密资源区域一定是通过服务端签名访问

  ​

> 为 OSS 配置 CDN 服务并配置域名

- CDN服务比较烧钱，前期可以不用加此服务，配置的域名最好能看出带有CDN服务，比如cdn.video.domain.com、cdn.static.domain.com

- 在生产服务发包时，如果已经部署了CDN服务，当OSS或者外部资源文件有变动时，记得手动操作阿里云CDN控制台清理缓存，否则可能出现生产资源一直未变化的情况。

  ​

> 业务服务集群化，不能出现单点服务

- 当大流量非常大时，有两台或两台以上服务器负载均衡可以分流压力。

- 服务集群化后，再加上负载均衡服务，当产品上线时，可以逐台发布应用做到热部署。

- 在有流量高峰时段，可以自由增减服务器，灵活配置节约成本。

- 每个业务项目独占固定端口，比方说，基础服务端口：16001，支付服务：16002，那么一台服务器可以挂载多个应用，需要增加服务时只需将此ECS实例复刻一份，再把新实例加入到负载均衡列表就可以立即生效。

- 创建负载均衡时一定要勾选健康(心跳)检查选项，当后端两台服务中的一台重启上，请求会立刻转发给另一台存活的服务，否则用户会得到响应超时。

  ​

> 配置网络安全组

- 将业务生产机器分配到同一安全组，并掐断公网任意协议或端口访问，内网只允许本组或堡垒机组访问。
- 将堡垒机或跳板机单独分配安全组，只针对特定固定IP开放指定SSH公网端口号，禁止公网与内网任意协议或端口访问。

  ​

> 业务服务划分模块化，配置独立二级域名

- 用户资产相关、支付相关、网页相关、网站电商相关、短信服务、定时任务服务、运营平台相关单独拆分成独立业务项目

- 独立业务项目需要定义二级域名，类似 app.domain.com、pay.domain.com、op.domain.com 

  ​

> 耗时操作全部异步队列化

- 前期可以搭建自己的队列服务，业务量上来后，再用阿里云队列替代方案最佳。
- 类似发帖、发内容、投票等业务异步发送消息体到队列服务器，让消费者服务处理。

  ​

> 云RDS数据库主从配置

- 设置RDS网络安全黑白名单，只允许生产安全组内网地址访问数据库。
- 设置DMS网络安全黑白名单，只允许指定固定IP使用。
- 通过RDS访问数据报表，查询夜间访问量最小的时间段，设置此时间段自动备份数据库。
- 在公司内网物理机器编写脚本定时下载备份文件，定期通过备份文件更新公司SIT数据库。
- 不要打开RDS数据库公网服务，让应用走内网地址访问，这样做速度快，安全高，性能好。

  ​

> 定期清理长时间未使用的OSS引用资源

- OSS 存储可选择流量和容量方式计费，定期的清理无引用的文件可降低成本。






### 百万注册用户开销有多少？

> 注：CDN费用由当月用户量流量大小决定，400元-4000元每月的情况都有，当然相对收益，流量费就不算多了。

| 产品名称    |   应用名称   |  付款方式   | 月费用(最低)  | 年费用(最低)  |
| ------- | :------: | :-----: | :------: | :------: |
| SLB负载均衡 |   SLB    |  按流量付费  |   150元   |  1800元   |
| RDS云数据库 |  RDS主从   | 包年包月/整年 |   300元   |  3600元   |
| OSS对象存储 |   OSS    |  按流量付费  |   300元   |  3600元   |
| CDN内容分发 |   CDN    |  按流量付费  |   600元   |  7200元   |
| 万网域名服务  |  域名 x2   | 包年包月/整年 |   9.8元   |   118元   |
| 安全证书服务  |  HTTPS   | 包年包月/整年 | 125.75元  |  1509元   |
| 聊天服务    |  腾讯IM聊天  | 包年包月/整年 |    0元    |    0元    |
| 消息推送    |    个推    | 包年包月/整年 |    0元    |    0元    |
| 邮件服务    |  腾讯企业邮箱  | 包年包月/整年 |    0元    |    0元    |
| 数据打点    |    友盟    | 包年包月/整年 |    0元    |    0元    |
| 短信服务    |  容联云通讯   | 包年包月/整年 |   150元   |  1800元   |
| ECS云服务器 | Redis x2 | 包年包月/整年 |  287.3元  | 3447.6元  |
| ECS云服务器 |   消息队列   | 包年包月/整年 |   166元   |  2000元   |
| ECS云服务器 |  基础服务x2  | 包年包月/整年 |  91.8元   | 1101.6元  |
| ECS云服务器 |  支付服务x2  | 包年包月/整年 |  91.8元   | 1101.6元  |
| ECS云服务器 |  网页服务x2  | 包年包月/整年 |  91.8元   | 1101.6元  |
| ECS云服务器 |  电商服务x2  | 包年包月/整年 |  91.8元   | 1101.6元  |
| ECS云服务器 |   后台服务   | 包年包月/整年 |  45.9元   |  550.8元  |
| ECS云服务器 |   事件服务   | 包年包月/整年 |  45.9元   |  550.8元  |
| ECS云服务器 |   消息服务   | 包年包月/整年 |  45.9元   |  550.8元  |
| ECS云服务器 |   任务服务   | 包年包月/整年 |  45.9元   |  550.8元  |
| ECS云服务器 |   跳板机    | 包年包月/整年 |  45.9元   |  550.8元  |
| 费用汇总    |          |         | 2675.55元 | 32106.6元 |




> 对业务需求与云产品越了解，越能让成本大幅下降，节省开销。

- 云服务内网之间的通信是免费并且流量大速度快，平均有 10M 每秒的传输带宽，但跨地区服务器比如（华东、华北、香港、北美)）内网是相互不通的，所以选择固定区域，让服务之间内网通信，是节省成本保证效率的方式。
- 资源文件（图片、视频、音频、小文件、JS/CSS）推荐用云存储 OSS，OSS 按流量与存储量收费，前期流量与存储量小时，费用非常低。
- 因为所有资源文件在云存储上，所以ECS服务器无需购买硬盘 IO 优化服务，选择默认最小硬盘，关闭外网功能，选择年付方式享受折扣；虽然阿里云提供 Web 方式管理控制台，笔者还是建议单独购买一台有外网功能的跳板机用于管理业务系统，登陆跳板机后用内网 IP 访问其他业务服务器不产生任何流量费，笔者有 12 台业务系统，单核单兆内存服务器平均每月花费 45.9＊12 = 550.8 元，负载均衡流量费用平均在每月 150 左右，只有当用户量突然增大时才会产生较高的费用。






 ### 从零到壹的服务搭建

